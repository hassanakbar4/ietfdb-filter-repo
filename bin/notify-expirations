#!/usr/bin/env python

import datetime

from django.db.models import Q

from ietf.idtracker.models import InternetDraft,IDAuthor,WGChair
from ietf.utils.mail import send_mail_subj

days_to_expire = 183 # Value subject to debate

start_date = datetime.date.today() - datetime.timedelta(days_to_expire)
end_date = start_date + datetime.timedelta(14)

q_objs = [Q(revision_date__gte=start_date),Q(revision_date__lte=end_date)]

matches = InternetDraft.objects.filter(*q_objs)

#For development - focus on one draft
#matches = InternetDraft.objects.all().filter(filename__icontains='geopriv-deref-protocol')
#matches = InternetDraft.objects.all().filter(filename__icontains='geopriv-http-location-delivery')

for draft in matches:
    authors = draft.authors.all()
    to_addrs = [author.email() for author in authors]
    cc_addrs= None;
    if draft.group.acronym != 'none':
        cc_addrs = [chair.person.email() for chair in WGChair.objects.filter(group_acronym=draft.group)]
    
    send_mail_subj(None, to_addrs, None, 'notify_expirations/subject.txt', 'notify_expirations/body.txt', 
                   {
                      'draft':draft,
                      'expiration':draft.revision_date+datetime.timedelta(days_to_expire),
                   },
                   cc_addrs)
